---

  - name: Install dependencies
    become: yes
    become_method: sudo
    apt: name={{item}} state=installed update_cache=true
    with_items:
      - apt-transport-https
      - ca-certificates
      - linux-image-extra-{{ ansible_kernel }}
    tags: ansible_docker

  - name: Add apt-key
    become: yes
    become_method: sudo
    apt_key: keyserver=hkp://p80.pool.sks-keyservers.net:80 id=58118E89F3A912897C070ADBF76221572C52609D state=present
    tags: ansible_docker

  - name: Add apt-repo for docker
    become: yes
    become_method: sudo
    apt_repository: repo="deb https://apt.dockerproject.org/repo ubuntu-{{ansible_lsb.codename}} main" state=present
    tags: ansible_docker

  - name: Make sure that lxc-docker is *not* there. (First update the cache tho)
    become: yes
    become_method: sudo
    apt:
      pkg: lxc-docker
      state: absent
      update_cache: yes
    tags: ansible_docker

  - name: Install docker-engine
    become: yes
    become_method: sudo
    apt:
      pkg: docker-engine
      state: installed
      update_cache: true
    tags: ansible_docker

  - name: Start docker
    become: yes
    become_method: sudo
    service:
      name: docker
      state: started
    tags: docker

  - name: Add docker group
    become: yes
    become_method: sudo
    group:
      name: docker
      state: present
    tags: ansible_docker

  - name: Check if {{ ansible_docker_user }} is an actual user
    become: yes
    become_method: sudo
    getent:
      database: passwd
      key: "{{ ansible_docker_user }}"
    register: ansible_docker_result
    when: ansible_docker_user is defined
    tags: ansible_docker

  - name: Add the ansible_docker_user to the docker group
    become: yes
    become_method: sudo
    user:
      name: "{{ ansible_docker_user }}"
      groups: docker
      append: yes
    when: ansible_docker_user is defined
    tags: ansible_docker
